<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finan√ßas Pro - Dashboard Diego</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --warning: #f1c40f; --purple: #a29bfe; --accent: #2980b9; --bg-card: rgba(255, 255, 255, 0.98); }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-image: url('https://www.hostelworld.com/blog/wp-content/uploads/2018/08/IMG_9162-1400x788.jpg'); 
            background-size: cover; background-position: center; background-attachment: fixed;
            padding: 20px; display: flex; justify-content: center; margin: 0;
        }

        #login-screen, #modal-registro, #modal-settings { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        #modal-registro, #modal-settings { display: none; z-index: 1001; }
        .login-box { background: white; padding: 35px; border-radius: 20px; width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        .container { width: 100%; max-width: 1200px; display: none; flex-direction: column; gap: 20px; }
        .card { background: var(--bg-card); padding: 25px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); position: relative; }
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 1000px) { .grid-layout { grid-template-columns: 1fr; } }
        
        .user-header { display: flex; align-items: center; gap: 10px; background: #ecf0f1; padding: 8px 18px; border-radius: 30px; border: 1px solid #ddd; }
        .gear-btn { cursor: pointer; font-size: 18px; transition: transform 0.3s; display: inline-block; }
        .gear-btn:hover { transform: rotate(90deg); }
        
        .input-group { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        button { cursor: pointer; border: none; border-radius: 8px; padding: 12px; color: white; font-weight: bold; transition: 0.3s; }
        .btn-add { background: var(--accent); width: 100%; margin-bottom: 10px; }
        .btn-save { background: var(--success); width: 100%; font-size: 16px; margin-top: 15px; }
        
        .summary-box { display: flex; justify-content: space-around; text-align: center; margin-top: 15px; background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #eee; }
        h2 { color: var(--primary); margin-top: 0; border-left: 5px solid var(--accent); padding-left: 15px; font-size: 1.1rem; text-transform: uppercase; }
        .chart-wrapper { height: 320px; position: relative; margin-bottom: 10px; }
        
        .filter-period { background: #f1f2f6; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; font-size: 13px; font-weight: bold; }
        
        /* Estilo da nova tabela de resumo */
        .mini-summary-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        .mini-summary-table th { text-align: left; padding: 8px; border-bottom: 2px solid #ddd; color: var(--primary); }
        .mini-summary-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .val-pos { color: var(--success); font-weight: bold; }
        .val-neg { color: var(--danger); font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Acesso Finan√ßas</h2>
            <input type="email" id="email" placeholder="E-mail" style="width:100%; margin-bottom:10px">
            <input type="password" id="senha" placeholder="Senha" style="width:100%; margin-bottom:20px">
            <button onclick="login()" style="background: var(--success); width: 100%; margin-bottom: 10px;">Entrar</button>
            <button onclick="document.getElementById('modal-registro').style.display='flex'" style="background: var(--accent); width: 100%;">Criar Conta</button>
            <p id="msg-erro" style="color: var(--danger); margin-top: 10px; font-size: 13px;"></p>
        </div>
    </div>

    <div id="modal-registro">
        <div class="login-box">
            <h2>Novo Usu√°rio</h2>
            <input type="text" id="reg-username" placeholder="Nome de Usu√°rio" style="width:100%; margin-bottom:20px">
            <button onclick="finalizarCadastro()" style="background: var(--success); width: 100%; margin-bottom: 10px;">Confirmar Registro</button>
            <button onclick="document.getElementById('modal-registro').style.display='none'" style="background: #95a5a6; width: 100%;">Voltar</button>
            <p id="msg-erro-reg" style="color: var(--danger); margin-top: 10px; font-size: 12px;"></p>
        </div>
    </div>

    <div id="modal-settings">
        <div class="login-box">
            <h2>Configura√ß√µes</h2>
            <p style="font-size: 11px; color: #7f8c8d; margin-bottom: 15px;">Preencha apenas o que deseja alterar.</p>
            <label style="font-size: 12px; display: block; text-align: left; font-weight: bold;">Nome de Usu√°rio:</label>
            <input type="text" id="set-username" placeholder="Novo nome" style="width:100%; margin-bottom:15px">
            <label style="font-size: 12px; display: block; text-align: left; font-weight: bold;">Nova Senha:</label>
            <input type="password" id="set-password" placeholder="M√≠nimo 6 caracteres" style="width:100%; margin-bottom:20px">
            <button onclick="salvarConfiguracoes()" style="background: var(--success); width: 100%; margin-bottom: 10px;">SALVAR ALTERA√á√ïES</button>
            <button onclick="document.getElementById('modal-settings').style.display='none'" style="background: #95a5a6; width: 100%;">CANCELAR</button>
            <p id="msg-erro-set" style="color: var(--danger); margin-top: 10px; font-size: 12px;"></p>
        </div>
    </div>

    <div class="container" id="app-financeiro">
        <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <select id="mes-ref" onchange="carregarDadosPorMes()">
                    <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Mar√ßo</option>
                    <option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option>
                    <option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option>
                    <option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
                </select>
                <input type="number" id="ano-ref" value="2026" style="width: 70px;" onchange="carregarDadosPorMes()">
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="user-header">
                    <span class="gear-btn" onclick="abrirConfiguracoes()">‚öôÔ∏è</span>
                    <span>Bem-vindo, <b id="display-username">...</b></span>
                </div>
                <button onclick="logout()" style="background: #95a5a6; padding: 8px 15px;">Sair</button>
            </div>
        </div>

        <div class="card">
            <h2>Resumo Mensal</h2>
            <div class="chart-wrapper"><canvas id="graficoRosca"></canvas></div>
            <div class="summary-box">
                <div><small>Ganhos</small><br><span id="txt-entradas" style="color: var(--success); font-weight:bold;">R$ 0,00</span></div>
                <div><small>Gastos</small><br><span id="txt-saidas" style="color: var(--danger); font-weight:bold;">R$ 0,00</span></div>
                <div><small>Saldo</small><br><span id="txt-saldo" style="font-weight:bold;">R$ 0,00</span></div>
            </div>
        </div>

        <div class="grid-layout">
            <div class="card">
                <h2>Lan√ßamentos</h2>
                <input type="number" id="renda-base" placeholder="Sal√°rio Base" style="width:100%; margin-bottom:15px; font-weight:bold" oninput="atualizarGraficos()">
                <div id="lista-financeira"></div>
                <button class="btn-add" onclick="addLinhaFinan()">+ Item</button>
                <button class="btn-save" onclick="salvarTudo()">üíæ Salvar M√™s</button>
                <p id="status-salvamento" style="font-size: 11px; text-align: center; margin-top: 5px;"></p>
            </div>

            <div class="card">
                <h2>Evolu√ß√£o Financeira</h2>
                <div class="filter-period">
                    <span>De:</span>
                    <select id="filt-mes-ini">
                        <option value="0">Jan</option><option value="1">Fev</option><option value="2">Mar</option>
                        <option value="3">Abr</option><option value="4">Mai</option><option value="5">Jun</option>
                        <option value="6">Jul</option><option value="7">Ago</option><option value="8" selected>Set</option>
                        <option value="9">Out</option><option value="10">Nov</option><option value="11">Dez</option>
                    </select>
                    <input type="number" id="filt-ano-ini" value="2025" style="width: 60px;">
                    <span>At√©:</span>
                    <select id="filt-mes-fim">
                        <option value="0">Jan</option><option value="1">Fev</option><option value="2">Mar</option>
                        <option value="3">Abr</option><option value="4">Mai</option><option value="5">Jun</option>
                        <option value="6">Jul</option><option value="7">Ago</option><option value="8">Set</option>
                        <option value="9">Out</option><option value="10" selected>Nov</option><option value="11">Dez</option>
                    </select>
                    <input type="number" id="filt-ano-fim" value="2026" style="width: 60px;">
                    <button onclick="atualizarLinhaTempo()" style="background: var(--accent); padding: 5px;">Filtrar</button>
                </div>
                <div class="chart-wrapper"><canvas id="graficoLinha"></canvas></div>
                
                <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                
                <h2>Comparativo (3 Meses)</h2>
                <div id="resumo-3-meses">
                    </div>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBLMafeGH367Yo6nxhNG5tldtiaNDFKiIE",
        authDomain: "minhas-finan-2026.firebaseapp.com",
        databaseURL: "https://minhas-finan-2026-default-rtdb.firebaseio.com",
        projectId: "minhas-finan-2026",
        storageBucket: "minhas-finan-2026.firebasestorage.app",
        messagingSenderId: "799859629947",
        appId: "1:799859629947:web:e7eefb2e067124578da7de"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let chartRosca = null, chartLinha = null;
    let currentUsername = "";
    const nomesMeses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

    function login() { 
        auth.signInWithEmailAndPassword(email.value, senha.value).catch(e => document.getElementById('msg-erro').innerText = e.message); 
    }

    async function finalizarCadastro() {
        const u = document.getElementById('reg-username').value.trim();
        if(u.length < 3) return;
        const snap = await db.ref('usernames/' + u.toLowerCase()).once('value');
        if(snap.exists()) { document.getElementById('msg-erro-reg').innerText = "Nome j√° existe!"; return; }

        auth.createUserWithEmailAndPassword(email.value, senha.value).then(res => {
            db.ref('usernames/' + u.toLowerCase()).set(res.user.uid);
            db.ref('users/' + res.user.uid + '/perfil').set({ nome: u });
            alert("Conta criada com sucesso!");
            location.reload();
        }).catch(e => document.getElementById('msg-erro-reg').innerText = e.message);
    }

    function abrirConfiguracoes() {
        document.getElementById('set-username').value = currentUsername;
        document.getElementById('set-password').value = "";
        document.getElementById('msg-erro-set').innerText = "";
        document.getElementById('modal-settings').style.display = 'flex';
    }

    async function salvarConfiguracoes() {
        const user = auth.currentUser;
        const newName = document.getElementById('set-username').value.trim();
        const newPass = document.getElementById('set-password').value;
        const msg = document.getElementById('msg-erro-set');
        msg.innerText = "Processando...";
        try {
            if (newName && newName.toLowerCase() !== currentUsername.toLowerCase()) {
                const snap = await db.ref('usernames/' + newName.toLowerCase()).once('value');
                if (snap.exists()) { msg.innerText = "Este nome de usu√°rio j√° est√° em uso!"; return; }
                await db.ref('usernames/' + currentUsername.toLowerCase()).remove();
                await db.ref('usernames/' + newName.toLowerCase()).set(user.uid);
                await db.ref('users/' + user.uid + '/perfil').update({ nome: newName });
                currentUsername = newName;
            }
            if (newPass) {
                if (newPass.length < 6) { msg.innerText = "A senha deve ter no m√≠nimo 6 caracteres."; return; }
                await user.updatePassword(newPass);
            }
            alert("Dados atualizados com sucesso!");
            document.getElementById('modal-settings').style.display = 'none';
        } catch (e) {
            msg.innerText = e.code === 'auth/requires-recent-login' ? "Erro: Saia e entre novamente." : "Erro: " + e.message;
        }
    }

    function logout() { auth.signOut().then(() => location.reload()); }

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-financeiro').style.display = 'flex';
            db.ref('users/' + user.uid + '/perfil/nome').on('value', snap => {
                currentUsername = snap.val() || "Usu√°rio";
                document.getElementById('display-username').innerText = currentUsername;
            });
            carregarDadosPorMes();
        }
    });

    function addLinhaFinan(dados = { desc: '', valor: '', tipo: 'saida' }) {
        const div = document.createElement('div');
        div.className = 'input-group finan-item';
        div.innerHTML = `<input type="text" class="f-desc" placeholder="Gasto" value="${dados.desc}" oninput="atualizarGraficos()">
            <input type="number" class="f-valor" placeholder="R$" value="${dados.valor}" oninput="atualizarGraficos()">
            <select class="f-tipo" onchange="atualizarGraficos()"><option value="saida" ${dados.tipo=='saida'?'selected':''}>Perda</option><option value="entrada" ${dados.tipo=='entrada'?'selected':''}>Ganho</option></select>
            <button style="background:var(--danger)" onclick="this.parentElement.remove(); atualizarGraficos();">X</button>`;
        document.getElementById('lista-financeira').appendChild(div);
        atualizarGraficos();
    }

    function salvarTudo() {
        const user = auth.currentUser;
        const path = document.getElementById('ano-ref').value + "_" + nomesMeses[document.getElementById('mes-ref').value];
        let lanc = [];
        document.querySelectorAll('.finan-item').forEach(el => {
            lanc.push({ desc: el.querySelector('.f-desc').value, valor: el.querySelector('.f-valor').value, tipo: el.querySelector('.f-tipo').value });
        });
        db.ref('users/' + user.uid + '/meses/' + path).set({ renda: document.getElementById('renda-base').value, lancamentos: lanc }).then(() => {
            document.getElementById('status-salvamento').innerText = "‚úÖ Salvo!";
            carregarDadosPorMes(); // Recarrega para atualizar o resumo de 3 meses
        });
    }

    function carregarDadosPorMes() {
        const user = auth.currentUser;
        const path = document.getElementById('ano-ref').value + "_" + nomesMeses[document.getElementById('mes-ref').value];
        db.ref('users/' + user.uid + '/meses/' + path).once('value').then(snap => {
            const d = snap.val();
            document.getElementById('lista-financeira').innerHTML = '';
            document.getElementById('renda-base').value = d ? d.renda : '';
            if (d && d.lancamentos) d.lancamentos.forEach(i => addLinhaFinan(i));
            atualizarGraficos();
            atualizarLinhaTempo();
            gerarResumoTrimestral();
        });
    }

    function atualizarGraficos() {
        let labels = ['Base'], valores = [parseFloat(document.getElementById('renda-base').value) || 0], cores = ['#27ae60'];
        let inT = valores[0], outT = 0;
        document.querySelectorAll('.finan-item').forEach(el => {
            let v = parseFloat(el.querySelector('.f-valor').value) || 0;
            let t = el.querySelector('.f-tipo').value;
            labels.push(el.querySelector('.f-desc').value || 'Item'); valores.push(v);
            if (t === 'entrada') { inT += v; cores.push('#27ae60'); } 
            else { 
                outT += v;
                if (v <= 300) cores.push('#a29bfe'); else if (v <= 700) cores.push('#f1c40f'); else cores.push('#e74c3c'); 
            }
        });
        if (chartRosca) chartRosca.destroy();
        chartRosca = new Chart(document.getElementById('graficoRosca'), {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ data: valores, backgroundColor: cores, hoverOffset: 35 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });
        document.getElementById('txt-entradas').innerText = "R$ " + inT.toFixed(2);
        document.getElementById('txt-saidas').innerText = "R$ " + outT.toFixed(2);
        document.getElementById('txt-saldo').innerText = "R$ " + (inT - outT).toFixed(2);
    }

    async function gerarResumoTrimestral() {
        const user = auth.currentUser;
        const mesAtual = parseInt(document.getElementById('mes-ref').value);
        const anoAtual = parseInt(document.getElementById('ano-ref').value);
        let html = `<table class="mini-summary-table"><tr><th>M√™s</th><th>Ganho</th><th>Gasto</th><th>Saldo</th></tr>`;
        
        // Vamos pegar os √∫ltimos 3 meses (Atual, -1, -2)
        for (let i = 0; i < 3; i++) {
            let d = new Date(anoAtual, mesAtual - i, 1);
            let chave = d.getFullYear() + "_" + nomesMeses[d.getMonth()];
            let snap = await db.ref('users/' + user.uid + '/meses/' + chave).once('value');
            let data = snap.val();
            
            let g = 0, p = 0;
            if (data) {
                g += parseFloat(data.renda) || 0;
                if (data.lancamentos) data.lancamentos.forEach(l => {
                    if (l.tipo === 'entrada') g += parseFloat(l.valor) || 0;
                    else p += parseFloat(l.valor) || 0;
                });
            }
            let saldo = g - p;
            html += `<tr>
                <td>${nomesMeses[d.getMonth()].substring(0,3)}/${d.getFullYear().toString().substring(2)}</td>
                <td class="val-pos">R$ ${g.toFixed(2)}</td>
                <td class="val-neg">R$ ${p.toFixed(2)}</td>
                <td class="${saldo >= 0 ? 'val-pos' : 'val-neg'}">R$ ${saldo.toFixed(2)}</td>
            </tr>`;
        }
        html += `</table>`;
        document.getElementById('resumo-3-meses').innerHTML = html;
    }

    async function atualizarLinhaTempo() {
        const user = auth.currentUser;
        if (!user) return;
        const snap = await db.ref('users/' + user.uid + '/meses').once('value');
        const todos = snap.val() || {};
        let dS = [], dE = [], labels = [];
        let dataAux = new Date(document.getElementById('filt-ano-ini').value, document.getElementById('filt-mes-ini').value, 1);
        const dataLimite = new Date(document.getElementById('filt-ano-fim').value, document.getElementById('filt-mes-fim').value, 1);
        while (dataAux <= dataLimite) {
            let chave = dataAux.getFullYear() + "_" + nomesMeses[dataAux.getMonth()];
            let sO = 0, sI = 0;
            if (todos[chave]) {
                sI += parseFloat(todos[chave].renda) || 0;
                if (todos[chave].lancamentos) todos[chave].lancamentos.forEach(l => {
                    if (l.tipo === 'saida') sO += parseFloat(l.valor); else sI += parseFloat(l.valor);
                });
            }
            labels.push(nomesMeses[dataAux.getMonth()].substring(0,3) + " " + dataAux.getFullYear().toString().substring(2));
            dS.push(sO); dE.push(sI);
            dataAux.setMonth(dataAux.getMonth() + 1);
            if(labels.length > 60) break;
        }
        if (chartLinha) chartLinha.destroy();
        chartLinha = new Chart(document.getElementById('graficoLinha'), {
            type: 'line',
            data: { labels, datasets: [{ label: 'Gastos', data: dS, borderColor: '#e74c3c', tension: 0 }, { label: 'Ganhos', data: dE, borderColor: '#27ae60', tension: 0 }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
</script>
</body>
</html>
